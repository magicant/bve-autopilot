# bve-autopilot アルゴリズム解説

この文書は bve-autopilot プラグインのアルゴリズム設計の解説です。開発者が本プラグインのコードを読解するための手掛かりとなることを意図しています。また、他の TASC/ATO プラグインの開発をしようとする人にとっても参考になるでしょう (ただし全てを自分で成し遂げたい人にとってはネタバレになるのでお帰りください)。

## TASC

### 減速度を一定に保つこと

TASC の目標は、ブレーキを制御して列車を所定の停止位置にできるだけ正確に止めることです。副次的な目標としては、できるだけブレーキを滑らかにかつ緩やかに制御するということが挙げられるかもしれません。この目標を達成するために最も重要な秘訣は、**ブレーキの減速度をなるべく一定に保つ**ことです。以下にその理由と方法を順に述べます。

BVE の車両プラグインは車両の減速度を自由に変化させることはできず、あくまでもブレーキ指令のノッチを BVE 本体に伝えることができるだけです。プラグインがブレーキ指令を変更しても、ブレーキの減速度が実際に変化するまでには多少の時間差があります。またブレーキシリンダーの圧力やモーターの電流が一瞬でパッと変化するということはないので、減速度も多少の時間をかけてなだらかに変化します。もしプラグインが減速度を特定のタイミングで変化させようとする場合、このようなブレーキの応答の遅れを見越して早めにブレーキ指令を変化させるということをする必要がありますが、そのような計算を行うことはとても難しいのが現実です。特に、ブレーキ指令を変化させたあと減速度が変化する前に次のブレーキ指令を計算しなければならないという事実が状況を非常に複雑にしています。したがって、減速度を特定のタイミングで変化させようとしてもタイミングがずれてしまうことが多く、停止直前にこれが起きると停止位置がずれる要因になります。つまり、減速度が変化するタイミングがずれると困るような変化のさせ方をしてはいけないのです。

逆に考えると、減速度が変化するタイミングが多少前後しても問題ないやり方なら減速度をうまく変化させることができます。そのもっとも単純なやり方は「目標となる減速度を決めて、その減速度に徐々に近付くように減速度を変化させてゆく」ことです。減速度を一気に変化させるのではなくある程度の時間をかけて変化させるので、減速度を変化させるタイミングを気にする必要がなくなります。

このやり方で実際に列車を止めるには、等減速度運動による減速パターンを目標とします。以下のような基準でブレーキ指令を計算します:

* 列車の現在位置・速度が減速パターンに一致しているなら、そのまま減速パターンの減速度で減速し続けるようにします。
* 列車が減速パターンを超えている (速度が出過ぎている) なら減速パターンの減速度より強く減速し、列車の動きが減速パターンに戻るように仕向けます。
* 列車が減速パターンよりゆっくり走っているならば、減速パターンの減速度より弱く減速し、列車の動きが減速パターンに近付くように仕向けます。

ここで、減速パターンとずれているときにどれほど減速度を強く (あるいは弱く) するかを計算するにあたっては、列車が減速パターンに**徐々に**近付くように仕向けなくてはいけません。また、どのみち列車の動きには多かれ少なかれ誤差が出るので、減速パターンから外れたときに減速パターンに戻るように仕向ける必要もあります。

bve-autopilot プラグインでは、以下の式を基本の考え方としています。

* 出力減速度 = 期待減速度 - (期待速度 - 現在速度) / 2秒

ただし

* 出力減速度 = プラグインが BVE 本体に伝えるブレーキ指令の減速度
* 期待減速度 = 目標とする減速パターンの減速度
* 期待速度 = 現在位置において減速パターンに沿って減速していた場合の理想的な速度

です。この式は、単純に説明すれば「2 秒後に列車が減速パターンに到達するような減速度をブレーキ指令として出力する」という意味になります。ただし、期待速度と現在速度は刻々と変化しその度に出力減速度はこの式で再計算されることに注意してください。常にその時から 2 秒後に減速パターンに到達するように仕向けることで、減速パターンに近付くほど減速パターンへ近付く速さが緩やかになり、減速パターンに**徐々に**近付く効果が得られます。

bve-autopilot プラグインで[実際に使っている式](bve-autopilot/減速パターン.cpp)は、上記の式に少し手を加えて

* 出力減速度 = 期待減速度 * (現在速度 / 期待速度) - (期待速度 - 現在速度) / 2秒

となっています。この変形の理由はソースコード内にコメントしてありますが、どのみち (現在速度 / 期待速度) の値はおおよそ 1 なので、あまり気にしなくて構いません。

### 停止直前の挙動

列車が停止する直前は上の計算式をそのまま使うと急激に出力減速度が変化することがあるので、別途対策が必要となります。

どうして出力減速度が急激に変化するのか見てみましょう。期待減速度が 2.50 km/h/s で停止位置まで残り 0.05 m だとすると、その位置での期待速度は約 0.95 km/h となります。現在速度はこれを少し上回る 1.2 km/h だとしましょう。この時、上に式に従うと出力減速度は約 3.29 km/h/s と計算されます。では 3.29 km/h/s でここから 0.15 秒間減速し続けたとします (実際にはブレーキ応答の遅れやその他もろもろの誤差の影響でそのような理想的な動きにはなりませんが、ここでは計算を分かりやすくするためにそういうことにしておきます)。そうすると列車は 0.15 秒間で停止位置まで残り約 0.01 m のところまで進み、現在速度は約 0.71 km/h となります。ここでもう一度期待速度と出力減速度を計算すると、それぞれ約 0.43 km/s と約 4.25 km/h/s となります。わずか 0.15 秒の間に、出力減速度が約 1.3 倍に上昇 (3.29 km/h/s → 4.25 km/h/s) してしまいました。実際の運転でこのようなことをすれば、列車が停止する寸前に突然急ブレーキがかかることになります。

そもそも上の出力減速度を計算する式は、出力減速度が段々と期待減速度に近付いてゆくことを意図していたはずです。それなのに、最初 3.29 km/h/s だった出力減速度は期待減速度 2.50 km/h/s に近付くように減少するどころかむしろ 4.25 km/h/s に上昇してしまっています。なぜうまくいかないのでしょうか?

出力減速度の計算式の意味をもう一度考え直してみましょう。この式は、「2 秒後に列車が減速パターンに到達するような減速度をブレーキ指令として出力する」ものでした。では、今回の場合の 2 秒後とは一体何でしょうか。列車は停止位置まで残り 0.05 m まで迫っており、速度は 1.2 km/h まで落ちています。ここから 2 秒後、列車はもう停止してしまっています! 上の計算式は減速度を変化させてゆくのに十分な時間の余裕があるときにはうまく機能しますが、時間がないときにそれを何とかする力はないのです。

この問題に対する解決策として、bve-autopilot プラグインでは上の式の他に以下の式を計算に組み込んでいます。

* 列車が減速パターンを超えている (速度が出過ぎている) とき → その時点の列車の位置と停止目標位置の中点を求め、その中点で減速パターンに戻るような減速度を出力します。これで、停止位置を行き過ぎそうになるのをある程度防ぎます。
* 列車が減速パターンよりゆっくり走っているとき → その時点の位置と速度から単純に等減速度運動で減速して行く場合の減速度と上の計算式の出力減速度を比較し、弱い方の減速度を出力します。これで、不必要に手前に止まってしまうことを防ぎます。

### 行き過ぎと衝撃緩和

また、上の計算式は停止位置を行き過ぎたときのことを何も考えていないという点も見逃せません。等減速度運動をベースにした計算では、停止位置をわずかでも行き過ぎると期待速度が存在しなくなるので出力減速度を計算することができなくなります。絶対に停止位置を行き過ぎないようにするということは不可能なので、行き過ぎたときにブレーキをどのように制御するかはこれまでとは全く別の方法で考える必要があります。

bve-autopilot プラグインでは、停止直前に (停止位置とは無関係に、列車の速度のみに基づいて) ブレーキをわざと弱めるようにしています。これは停止時の衝撃を緩和するのが主目的ですが、停止位置を行き過ぎたときにブレーキをどうするかいろいろ考えなくて済むというメリットもあります。やり方としては、減速度の変化が一定の速度となるように (つまり列車の動きが等加加速度運動となるように) ブレーキを緩めています。

### 不連続な計算式を避けること

一つの値を求めるために複数の計算式を組み合わせる場合は、値の不連続な変化を避けることが重要です。例えば以下の擬似コードは出力減速度が不連続に変化する悪い例です:

```
if (現在速度 < 5 km/h)
    出力減速度 = 現在速度 * 現在速度 / 2 / 残り距離
else
    出力減速度 = 期待減速度 * (現在速度 / 期待速度) - (期待速度 - 現在速度) / 2秒
```

このコード例だと、現在速度が 5 km/h 以上から 5 km/h 未満に変わる瞬間に出力減速度の計算式が全く異なるものに変わるので、その瞬間に出力減速度の値がガクッと急激に変化する可能性があります。既に述べたように、減速度を急激に変化させようとしてもブレーキの応答の遅れが災いして車両の挙動は安定しません。したがって、このような急激な (不連続な) 変化は避ける必要があります。

If-else 文で二つ以上の式からどれか一つの式の値を選ぶようなアルゴリズムにすると不連続な変化が発生しやすくなります。bve-autopilot プラグインでは max, min 関数で複数の式から値を選ぶようにして連続性を保っています。

## ATO

### ATC 路線

### 非 ATC 路線

## 発展的なブレーキ制御

### 空気ブレーキと電気ブレーキ

### ブレーキの利き具合への追随

### 抑速ブレーキ

### Pressure rates

### 拡張ブレーキ指令

