# アルゴリズム解説

この文書は bve-autopilot プラグインのアルゴリズム設計の解説です。開発者が本プラグインのコードを読解するための手掛かりとなることを意図しています。また、他の TASC/ATO プラグインの開発をしようとする人にとっても参考になるでしょう (ただし全てを自分で成し遂げたい人にとってはネタバレになるのでお帰りください)。

## TASC

### 減速度を一定に保つこと

TASC の目標は、ブレーキを制御して列車を所定の停止位置にできるだけ正確に止めることです。副次的な目標としては、できるだけブレーキを滑らかにかつ緩やかに制御するということが挙げられるかもしれません。この目標を達成するために最も重要な秘訣は、**ブレーキの減速度をなるべく一定に保つ**ことです。以下にその理由と方法を順に述べます。

BVE の車両プラグインは車両の減速度を自由に変化させることはできず、あくまでもブレーキ指令のノッチを BVE 本体に伝えることができるだけです。プラグインがブレーキ指令を変更しても、ブレーキの減速度が実際に変化するまでには多少の時間差があります。またブレーキシリンダーの圧力やモーターの電流が一瞬でパッと変化するということはないので、減速度も多少の時間をかけてなだらかに変化します。もしプラグインが減速度を特定のタイミングで変化させようとする場合、このようなブレーキの応答の遅れを見越して早めにブレーキ指令を変化させるということをする必要がありますが、そのような計算を行うことはとても難しいのが現実です。特に、ブレーキ指令を変化させたあと減速度が変化する前に次のブレーキ指令を計算しなければならないという事実が状況を非常に複雑にしています。したがって、減速度を特定のタイミングで変化させようとしてもタイミングがずれてしまうことが多く、停止直前にこれが起きると停止位置がずれる要因になります。つまり、減速度が変化するタイミングがずれると困るような変化のさせ方をしてはいけないのです。

逆に考えると、減速度が変化するタイミングが多少前後しても問題ないやり方なら減速度をうまく変化させることができます。そのもっとも単純なやり方は「目標となる減速度を決めて、その減速度に徐々に近付くように減速度を変化させてゆく」ことです。減速度を一気に変化させるのではなくある程度の時間をかけて変化させるので、減速度を変化させるタイミングを気にする必要がなくなります。

このやり方で実際に列車を止めるには、等減速度運動による減速パターンを目標とします。以下のような基準でブレーキ指令を計算します:

* 列車の現在位置・速度が減速パターンに一致しているなら、そのまま減速パターンの減速度で減速し続けるようにします。
* 列車が減速パターンを超えている (速度が出過ぎている) なら減速パターンの減速度より強く減速し、列車の動きが減速パターンに戻るように仕向けます。
* 列車が減速パターンよりゆっくり走っているならば、減速パターンの減速度より弱く減速し、列車の動きが減速パターンに近付くように仕向けます。

ここで、減速パターンとずれているときにどれほど減速度を強く (あるいは弱く) するかを計算するにあたっては、列車が減速パターンに**徐々に**近付くように仕向けなくてはいけません。また、どのみち列車の動きには多かれ少なかれ誤差が出るので、減速パターンから外れたときに減速パターンに戻るように仕向ける必要もあります。

bve-autopilot プラグインでは、以下の式を基本の考え方としています。

* 出力減速度 = 期待減速度 - (期待速度 - 現在速度) / 2秒

ただし

* 出力減速度 = プラグインが BVE 本体に伝えるブレーキ指令の減速度
* 期待減速度 = 目標とする減速パターンの減速度
* 期待速度 = 現在位置において減速パターンに沿って減速していた場合の理想的な速度

です。この式は、単純に説明すれば「2 秒後に列車が減速パターンに到達するような減速度をブレーキ指令として出力する」という意味になります。ただし、期待速度と現在速度は刻々と変化しその度に出力減速度はこの式で再計算されることに注意してください。常にその時から 2 秒後に減速パターンに到達するように仕向けることで、減速パターンに近付くほど減速パターンへ近付く速さが緩やかになり、減速パターンに**徐々に**近付く効果が得られます。

bve-autopilot プラグインで[実際に使っている式](bve-autopilot/減速パターン.cpp)は、上記の式に少し手を加えて

* 出力減速度 = 期待減速度 * (現在速度 / 期待速度) - (期待速度 - 現在速度) / 2秒

となっています。この変形の理由はソースコード内にコメントしてありますが、どのみち (現在速度 / 期待速度) の値はおおよそ 1 なので、あまり気にしなくて構いません。

### 不連続な計算式を避けること

### 停止直前の挙動

(停止直前に起こりうる出力減速度の急激な変化について)

## ATO

### ATC 路線

### 非 ATC 路線

## 発展的なブレーキ制御

### 空気ブレーキと電気ブレーキ

### ブレーキの利き具合への追随

### 抑速ブレーキ

### Pressure rates

### 拡張ブレーキ指令
